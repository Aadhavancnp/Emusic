{% extends 'base.html' %}

{% block title %}Dashboard - E-Music{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            {% if user.userprofile.profile_picture %}
                                <img src="{{ user.userprofile.profile_picture.url }}"
                                     class="card-img-top rounded-circle"
                                     style="width: 6rem; height: 6rem"
                                     alt="{{ user.username }}'s profile picture">
                            {% else %}
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                     style="width: 4rem; height: 4rem; font-size: 2rem;">
                                    {{ user.username|make_list|first|upper }}
                                </div>
                            {% endif %}
                            <div class="ms-3">
                                <h2 class="card-title">Welcome, {{ user.username }}!</h2>
                                <p class="card-text">Here's your personalized music dashboard.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Recommended for You</h3>
                        <div class="row">
                            {% for song in recommended_songs %}
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ song.name }}</h5>
                                            <p class="card-text">
                                                {{ song.artist }}
                                                <br/>
                                                <span>{{ song.album }}</span>
                                            </p>
                                            <a href="{% url 'track_redirection' song.name %}"
                                               class="btn btn-primary btn-sm">View
                                                Details</a>
                                            <button class="btn btn-secondary btn-sm mt-2"
                                                    onclick="addToPlaylist('{{ song.id }}')">Add to Playlist
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Your Playlists</h3>
                        <div class="row">
                            {% for playlist in user_playlists %}
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ playlist.name }}</h5>
                                            <a href="{% url 'playlist_detail' playlist.spotify_id %}"
                                               class="btn btn-primary btn-sm">View Playlist</a>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <p>No playlists yet.</p>
                            {% endfor %}
                        </div>
                        <a href="{% url 'create_playlist' %}" class="btn btn-success mt-3">Create New Playlist</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Your Stats</h3>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <strong>Listening Time:</strong> {{ listening_time|floatformat:2 }} hours
                            </li>
                            <li class="list-group-item">
                                <strong>Favorite Genre:</strong> {{ favorite_genre|default:"Not enough data" }}
                            </li>
                            <li class="list-group-item">
                                <strong>Playlist Count:</strong> {{ playlist_count }}
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Recent Activity</h3>
                        <ul class="list-group list-group-flush">
                            {% for activity in recent_activities %}
                                <li class="list-group-item">
                                    {{ activity.description }}
                                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                </li>
                            {% endfor %}
                        </ul>
                        <a href="{% url 'user_activities' %}" class="btn btn-primary btn-sm mt-3">View All
                            Activities</a>
                    </div>
                </div>

                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h3 class="card-title">Subscription Status</h3>
                        {% if subscription %}
                            <p>Current Plan: {{ subscription.plan.name }}</p>
                            <p>Expires: {{ subscription.end_date }}</p>
                        {% else %}
                            <p>No active subscription</p>
                            <a href="{% url 'subscription_plans' %}" class="btn btn-primary btn-sm">Subscribe Now</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div class="modal fade" id="addToPlaylistModal" tabindex="-1" aria-labelledby="addToPlaylistModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addToPlaylistModalLabel">Add to Playlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="playlistSelect" class="form-select">
                        {% for playlist in user_playlists %}
                            <option value="{{ playlist.spotify_id }}">{{ playlist.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAddToPlaylist()">Add to Playlist
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        let currentTrackId = '';

        function addToPlaylist(trackId) {
            currentTrackId = trackId;
            $('#addToPlaylistModal').modal('show');
        }

        function confirmAddToPlaylist() {
            const playlistId = document.getElementById('playlistSelect').value;

            fetch('{% url "add_to_playlist" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `track_id=${currentTrackId}&playlist_id=${playlistId}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Track added to playlist successfully!');
                    } else {
                        alert('Failed to add track to playlist. Please try again.');
                    }
                    $('#addToPlaylistModal').modal('hide');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    $('#addToPlaylistModal').modal('hide');
                });
        }
    </script>
{% endblock %}

